#/bin/bash

set -e

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

# Use the ubuntu-based image until the alpine one is ready
docker_image=quay.io/signalfuse/collectd-plugins:latest #-alpine

tmpdir=$(mktemp -d /tmp/collectd-rootfs-XXX)
trap "rm -rf $tmpdir" EXIT

mkdir ${tmpdir}/rootfs

container_id=$(docker create $docker_image)
trap "docker rm -f $container_id" EXIT

# Force success since Mac's bsdtar returns 1 even though everything seems to
# work fine
docker export $container_id | tar -C ${tmpdir}/rootfs -xvf - || true
echo "Ignore the above error on Mac."

# The entrypoint script for Docker changes the config in place, which is fine if
# you are using an overlay filesystem like Docker uses that reverts the changes
# upon container restart.  Runc by default doesn't do that and I am not
# comfortable using overlayfs in our runc container since it doesn't work with
# bosh-lite and perhaps not with some client's deployments.  Therefore, the
# simplest thing to do for now is just to copy this folder back to /etc/collectd
# upon container startup each time so that it can be restarted multiple times
# in one deployment.
mv ${tmpdir}/rootfs/etc/collectd ${tmpdir}/rootfs/etc/collectd.templates

tar -C $tmpdir -czf $SCRIPT_DIR/tmp/collectd-rootfs.tar.gz rootfs
